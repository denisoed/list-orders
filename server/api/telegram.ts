import { Telegraf, Markup } from 'telegraf'
import { eventHandler, readBody } from 'h3'

const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN as string)

function createWelcomeMessage(ctx: any) {
    const firstName = ctx.from?.first_name || ''
    const lastName = ctx.from?.last_name || ''
    const fullName = `${firstName} ${lastName}`.trim() || '????????????'

    return (
      `?????? <b>${fullName}</b>!\n\n` +
      '????? ?????????? ? ??????? ??? ?????????? ???????? ? ?????????!\n\n' +
      '????? ?? ?????? ????????? ????? ???????, ????????? ?????? ? ????????? ??? ? ????????? ??????. ' +
      '?? ? ????? ?????? ?????? ???????? ?????? ? ????? ???????? ? ???????.\n\n' +
      '????? ?????? ????, ????? ??????? ?????????? ? ?????? ??????.'
    )
  }

bot.start((ctx) => {
    ctx.replyWithHTML(
      createWelcomeMessage(ctx),
      Markup.inlineKeyboard([
        [Markup.button.webApp('???????', 'https://t.me/list_orders_bot/app')],
      ]),
    )
  })

export default eventHandler(async (event) => {
  const update = await readBody(event)
  if (!update) return 'no update'

  await bot.handleUpdate(update)
  return 'ok'
})
