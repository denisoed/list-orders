# Метрики эффективности проектов

**Specification:** Владельцу платформы управления заказами требуется набор аналитических метрик, который агрегирует данные из таблиц `projects`, `orders`, `order_history`, `order_reminder_logs` и `project_members`. Цель — дать целостную картину по загрузке, эффективности и финансовым показателям проектов, чтобы быстро видеть проблемные зоны и динамику изменений.

## User Stories
- Как владелец проекта, я хочу видеть сводку по активным и архивным проектам (количество, долю выполненных задач, дату последней активности), чтобы оценивать загрузку портфеля.
- Как владелец проекта, я хочу отслеживать эффективность выполнения заказов (скорость закрытия, долю просроченных, этапы на которых застревают), чтобы вовремя вмешиваться и перераспределять ресурсы.
- Как владелец проекта, я хочу контролировать финансовые показатели (сумма предоплат, ожидаемые платежи, оплаченные заказы) и качество клиентского обслуживания (возвраты на доработку, активированные напоминания), чтобы прогнозировать выручку и работу с клиентами.

## Main scenarios and rules
- Метрики агрегируются по выбранному проекту владельца с возможностью переключения на общий портфель. Источник данных — Supabase, таблицы `projects` (статусы, completed/total, archived), `orders` (status, due_date, assignee, amounts, payment_type, review_*), `order_history` (этапы и события), `order_reminder_logs` (рассылка напоминаний), `project_members` (состав команды).
- Страница метрик доступна по маршруту `/projects/:id/metrics`; вкладка «Метрики» на странице редактирования проекта открывает дашборд и передаёт параметры возврата, чтобы пользователь мог вернуться к настройкам или в список заказов.
- Основные показатели:
  - "Прогресс проекта": доля `completed/total`, количество активных/архивных проектов, время с последнего обновления (`projects.updated_at`).
  - "Воронка заказов": количество заказов по статусам, доля заказов со сменой статуса за период (по `order_history`), среднее время от создания (`orders.created_at`) до завершения (последний `status.done`).
  - "Сроки": число просроченных заказов (`due_date < now` и статус не `done`), доля задач завершённых вовремя (сравнение `due_date` и времени перехода в `done`).
  - "Нагрузка команды": распределение активных заказов по исполнителям (`orders.assignee_telegram_id` и `project_members`), среднее время в статусах по исполнителю.
  - "Финансы": сумма `total_amount`, сумма предоплат `prepayment_amount`, доля заказов без указания оплаты (`payment_type IS NULL`).
  - "Качество/ревью": количество заказов с заполненным `review_answer` или событиями возврата в `order_history`, доля заказов отправленных на доработку, среднее время между возвратом и повторным завершением.
  - "Напоминания": сколько напоминаний отправлено (`order_reminder_logs.sent_at`) и эффективность (доля задач завершённых после напоминания < 24ч).
- Метрики должны поддерживать фильтры по периоду (неделя, месяц, квартал) и по проектам. Используем `created_at`, `updated_at`, `order_history.created_at`, `order_reminder_logs.target_datetime`.
- Обновление данных происходит при каждом открытии дашборда и по таймеру (например, каждые 5 минут) с кешированием результатов на стороне клиента или API.
- Все вычисления выполняются на сервере (API) или в Supabase SQL представлениях; фронтент получает агрегированные данные.

## Non-functional requirements
- SLA построения виджета — не более 3 секунд при объёме до 10 тыс. заказов в проекте.
- Метрики должны корректно работать при частичном отсутствии данных (например, нет due_date или total_amount).
- Учесть локализацию: подписи и даты отображать на русском языке, валюту — в рублях без копеек.
- Обеспечить контроль доступа: владелец видит только свои проекты и связанные заказы/участников по `user_telegram_id`.
- Дашборд должен быть пригоден для расширения: новые метрики подключаются через единый API контракт.

## Assumptions
- Поля `completed` и `total` в `projects` отражают количество завершённых и всех задач и регулярно обновляются.
- Статусы заказов в `orders.status` согласованы со значениями, используемыми в `order_history.event_type` (`status.*`).
- Данные о ревью (`review_answer`, `review_images`) и напоминаниях (`order_reminder_logs`) уже собираются и доступны для аналитики.
- Нет отдельной таблицы оплат, поэтому финансовые показатели считаются из полей `prepayment_amount` и `total_amount`.
- Требуется уточнение, как определять факт оплаты (по статусу, полю `payment_type` или событиям) — без этого часть финансовых метрик будет ориентировочной.
