# Implementation Plan

**Plan:** Добавить новую страницу для отображения выбранной картинки на всю ширину, с возможностью зумить и перемещать. На этой странице добавить шапку со стандартной кнопкой Назад. Добавить кнопки управления зумом и т.д.

## Data sources / schemas

### Хранение данных изображений

- Изображения уже присутствуют в структуре данных заказов (судя по `pages/orders/[id].vue`, используется `order.attachments` с полями `id`, `name`, `previewUrl`).
- Не требуется создание новых таблиц или схем данных — изображения хранятся как часть существующей структуры заказов.
- Данные для страницы просмотра получаются из существующего источника (mock данные из `data/orders.ts` или будущий API).

### Параметры маршрута

**Вариант 1: Универсальный маршрут для изображений**

- Использование динамического роутинга Nuxt: `/images/[imageId]` с опциональными query-параметрами для контекста.
- Параметр `imageId` извлекается из `route.params.imageId`.
- Query-параметры:
  - `orderId` (string, optional) — для контекста заказа
  - `projectId` (string, optional) — для контекста проекта/создания заказа
  - `source` (string, optional) — источник перехода: `'order-details'` или `'task-create'`

**Вариант 2: Отдельные маршруты**

- Маршрут для заказов: `/orders/[id]/images/[imageId]` (параметры: `id`, `imageId`).
- Маршрут для создания заказа: `/projects/[id]/tasks/new/images/[imageId]` (параметры: `id`, `imageId`).

**Рекомендация:** Использовать Вариант 1 для упрощения и единообразия кода.

### Кэширование

- Использование встроенного кэширования браузера для загруженных изображений.
- Не требуется серверное кэширование на данном этапе (работа с mock данными).

## Contracts and interfaces

### Роутинг

**Рекомендуемый маршрут:** `/images/[imageId]`

- Параметры:
  - `imageId` (string) — идентификатор изображения в route.params
- Query-параметры (опционально, для контекста и возврата):
  - `orderId` (string, optional) — идентификатор заказа (для страницы деталей заказа)
  - `projectId` (string, optional) — идентификатор проекта (для страницы создания заказа)
  - `source` (string, optional) — источник перехода: `'order-details'` или `'task-create'`
  - `returnTo` (string, optional) — URL для возврата, если требуется явное указание

**Альтернативные маршруты:**

1. `/orders/[id]/images/[imageId]` — для просмотра из страницы деталей заказа
2. `/projects/[id]/tasks/new/images/[imageId]` — для просмотра из страницы создания заказа

**Преимущества универсального маршрута:**
- Единая реализация страницы просмотра
- Проще поддерживать и тестировать
- Гибкость для будущих источников изображений

### Интерфейсы компонентов

**ImageZoomPage.vue** (или `pages/images/[imageId].vue`)

```typescript
interface ImageZoomPageProps {
  // Props не требуются, данные берутся из route
}

interface ZoomState {
  scale: number // 1.0 - 5.0 (100% - 500%)
  translateX: number // пиксели смещения по X
  translateY: number // пиксели смещения по Y
  minScale: number // 1.0
  maxScale: number // 5.0
  step: number // 0.5 (50%)
}
```

**События компонента:**

- `@back` — событие для возврата на предыдущую страницу
- Внутренние события для обработки жестов (touchstart, touchmove, touchend, wheel)

### API для получения данных изображения

Если в будущем будет реализован API:

- `GET /api/orders/{orderId}/images/{imageId}` — получение метаданных изображения
- Ответ: `{ id: string, url: string, name: string, orderId: string }`

На текущем этапе используется mock данные из `data/orders.ts`.

### Валидация параметров

- Проверка наличия `imageId` в параметрах маршрута.
- Проверка валидности `imageId` (не пустая строка, допустимые символы).
- Обработка случая, когда изображение с указанным `imageId` не найдено:
  - Если `source === 'order-details'` и указан `orderId` — поиск в данных заказа.
  - Если `source === 'task-create'` и указан `projectId` — поиск в локальных attachment'ах формы создания заказа (может быть blob URL).
  - В ином случае — универсальная обработка ошибки.

## Architecture / Components

### Структура файлов

```
pages/
  images/
    [imageId].vue  # Универсальная страница просмотра изображения (рекомендуется)

# ИЛИ альтернативная структура:

pages/
  orders/
    [id]/
      images/
        [imageId].vue  # Страница просмотра для заказов
  projects/
    [id]/
      tasks/
        new/
          images/
            [imageId].vue  # Страница просмотра для создания заказа

components/
  ImageZoomControls.vue  # Компонент с кнопками управления зумом (опционально)
```

### Компоненты

1. **Pages: ImageZoomPage** (`pages/images/[imageId].vue`)
   - Универсальная страница просмотра изображения для разных источников
   - Управляет состоянием масштаба и позиции
   - Обрабатывает жесты и события мыши/клавиатуры
   - Содержит шапку с кнопкой "Назад"
   - Отображает кнопки управления зумом
   - Определяет источник изображения (заказ или форма создания) через query-параметры
   - Поддерживает работу как с серверными URL, так и с локальными blob URL

2. **Components: ImageZoomControls** (опционально)
   - Изолированный компонент для кнопок управления зумом
   - Принимает props: `currentScale`, `minScale`, `maxScale`
   - Эмитит события: `zoomIn`, `zoomOut`, `reset`

### Технологический стек

- **Frontend Framework:** Nuxt 3 / Vue 3
- **Роутинг:** Nuxt File-based Routing
- **Стилизация:** Tailwind CSS (как в остальном проекте)
- **Обработка жестов:** Нативные события браузера (touchstart, touchmove, touchend, wheel) или легковесная библиотека (например, `@vueuse/gesture` если требуется)
- **Анимации:** CSS transitions и Vue transitions для плавности

### Логика масштабирования и перемещения

**Масштабирование:**
- Использование CSS `transform: scale()` для изменения размера изображения.
- Хранение состояния масштаба в reactive ref Vue.
- Ограничение значений между `minScale` (1.0) и `maxScale` (5.0).

**Перемещение (Pan):**
- Использование CSS `transform: translate()` для перемещения изображения.
- Расчет границ перемещения на основе текущего масштаба и размеров изображения.
- Обработка событий `touchmove` и `mousemove` для drag-and-drop.

**Жесты pinch-to-zoom:**
- Отслеживание расстояния между двумя точками касания.
- Расчет изменения масштаба на основе изменения расстояния.
- Поддержка одновременного перемещения при зуме.

### Интеграция с существующим кодом

1. **Страница деталей заказа** (`pages/orders/[id].vue`):
   - Добавить обработчик клика на миниатюры изображений в секции "Примеры".
   - При клике выполнять навигацию на `/images/${attachment.id}?orderId=${orderId}&source=order-details`.

2. **Страница создания заказа** (`pages/projects/[id]/tasks/new.vue`):
   - Добавить обработчик клика на миниатюры изображений в секции "Фото примеров".
   - При клике выполнять навигацию на `/images/${attachment.id}?projectId=${projectId}&source=task-create`.
   - Учитывать, что URL изображения может быть локальным blob URL (из `File` объекта), а не серверным.

3. **Навигация:**
   - Использовать `router.push()` для перехода на страницу просмотра с передачей необходимых query-параметров.
   - Использовать `router.back()` для возврата на предыдущую страницу.
   - При отсутствии истории браузера использовать `returnTo` из query-параметров или построить URL на основе `source` и соответствующих ID.

4. **Стилизация:**
   - Следовать существующим паттернам дизайна из проекта (классы Tailwind, цветовая схема).
   - Использовать те же иконки Material Symbols Outlined, что и в других компонентах.

### Обработка ошибок

- Компонент обработки ошибок загрузки изображения.
- Fallback UI при отсутствии изображения или ошибке загрузки.
- Логирование ошибок для отладки (в режиме разработки).

## Risks

1. **Производительность на мобильных устройствах:**
   - Риск: Большие изображения могут вызывать лаги при масштабировании и перемещении.
   - Митигация: Использование CSS transforms (GPU-ускорение), оптимизация размеров изображений, lazy loading.

2. **Совместимость жестов:**
   - Риск: Различная обработка жестов в разных браузерах и устройствах.
   - Митигация: Тестирование на различных устройствах, использование проверенных библиотек при необходимости.

3. **UX на разных размерах экранов:**
   - Риск: Интерфейс может быть неудобен на очень маленьких или очень больших экранах.
   - Митигация: Адаптивный дизайн, тестирование на различных разрешениях, использование относительных единиц измерения.

4. **Передача данных между страницами:**
   - Риск: Потеря контекста при переходе между страницами (например, позиция скролла на исходной странице).
   - Митигация: Использование стандартного роутинга Nuxt, который сохраняет состояние через history API.

5. **Доступность:**
   - Риск: Функциональность может быть недоступна для пользователей клавиатуры или скринридеров.
   - Митигация: Добавление клавиатурной навигации, aria-labels, семантической разметки.

## Assumptions

1. Изображения уже существуют в структуре данных заказов и доступны по URL из поля `previewUrl` или аналогичного.

2. Не требуется реализация загрузки новых изображений на странице просмотра — только просмотр существующих.

3. Страница просмотра изображения является дополнением к существующей функциональности, а не заменой текущего отображения миниатюр.

4. На данном этапе достаточно работы с mock данными из `data/orders.ts` и локальными файлами из формы создания заказа. Интеграция с реальным API будет выполнена позже.

5. Стандартная шапка со кнопкой "Назад" должна соответствовать дизайну из `pages/orders/[id].vue` или `pages/profile/[id].vue`.

6. Кнопки управления зумом могут быть размещены в фиксированной панели внизу экрана или в правом нижнем углу, в зависимости от того, что лучше вписывается в дизайн.

7. Поддержка жестов touch реализуется через нативные события браузера. Если это окажется слишком сложным, можно использовать легковесную библиотеку типа `@vueuse/gesture`.

8. Анимации и переходы должны быть плавными (60 FPS), используя CSS transforms и transitions.

9. Страница должна корректно работать как в Telegram Web App, так и в обычном браузере.

