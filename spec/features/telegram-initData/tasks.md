# Orders

**Context:** На стороне клиента нужно отправлять на сервер telegram initData. На стороне сервера нужно добавить логику валидации initData. Результат выводить в console.log. Используется npm пакет `@telegram-apps/init-data-node`.

## Main directions

### Клиентская часть: получение и отправка initData

- [ ] Установить пакет `@telegram-apps/init-data-node` в зависимости проекта (через npm/pnpm/yarn).
- [ ] Расширить composable `useTelegram` или создать новый `useTelegramInitData`, добавив метод для получения `initData` из `window.Telegram.WebApp.initData`.
- [ ] Реализовать метод отправки initData на сервер через `$fetch` или `useFetch` на endpoint `/api/telegram/validate-init-data` (POST запрос с телом `{ initData: string }`).
- [ ] Добавить проверку наличия `initData` перед отправкой (если приложение запущено вне Telegram, не отправлять запрос).
- [ ] Интегрировать вызов метода отправки initData в плагин `plugins/telegram.client.ts` после успешной инициализации Telegram WebApp или вызвать при первом обращении к composable.

**Проверка:** Убедиться, что initData корректно получается на клиенте и отправляется на сервер при наличии Telegram WebApp. Проверить в DevTools Network tab, что запрос отправляется с корректными данными.

### Серверная часть: валидация initData

- [ ] Создать серверный route `server/api/telegram/validate-init-data.post.ts` (или использовать GET метод, если требуется).
- [ ] В handler endpoint получить `initData` из body запроса (или query параметра, если используется GET).
- [ ] Получить Bot Token из переменных окружения (например, `process.env.TELEGRAM_BOT_TOKEN`).
- [ ] Импортировать функцию `validate` из пакета `@telegram-apps/init-data-node`.
- [ ] Обернуть вызов `validate(initData, botToken)` в try-catch блок.
- [ ] При успешной валидации вывести в `console.log` сообщение: `[Telegram InitData Validation] Success: InitData is valid`.
- [ ] При ошибке валидации перехватить исключение, определить тип ошибки (если нужно) и вывести в `console.log`: `[Telegram InitData Validation] Error: <error message>` или `[Telegram InitData Validation] Error: <error type> - <error message>`.
- [ ] Вернуть HTTP ответ клиенту (например, статус 200 при успехе, 400 при ошибке валидации, 500 при других ошибках).

**Проверка:** Проверить, что валидация работает корректно с валидным initData и корректно обрабатывает ошибки (неверная подпись, истекший срок и т.д.). Убедиться, что результаты выводятся в консоль сервера.

### Конфигурация и окружение

- [ ] Добавить переменную окружения для Bot Token в документацию или .env.example файл (если используется).
- [ ] Убедиться, что Bot Token корректно читается из переменных окружения на сервере.

**Проверка:** Проверить, что приложение работает с корректным Bot Token и корректно обрабатывает отсутствие токена.

## Supporting orders

- [ ] Документация: обновить README или добавить комментарии в код, описывающие процесс валидации initData и требования к переменным окружения.
- [ ] Observability: логирование через `console.log` уже реализовано в основных задачах. При необходимости можно расширить формат логов для лучшей диагностики.
- [ ] Code review and PR: подготовить изменения для review, убедиться что код соответствует стилю проекта, типизирован через TypeScript, не содержит чувствительных данных в логах.

## Definition of Done

- [ ] Все задачи выполнены и протестированы.
- [ ] InitData корректно получается на клиенте и отправляется на сервер.
- [ ] Серверная валидация работает с пакетом `@telegram-apps/init-data-node` и выводит результаты в `console.log`.
- [ ] Ошибки валидации корректно обрабатываются и логируются.
- [ ] Код типизирован, проходит линтер без ошибок.
- [ ] Bot Token корректно читается из переменных окружения.
- [ ] `/spec/core/verify.md` выполнен после завершения всех задач для проверки списка задач.

