# Fetch User

**Specification:** добавить новый серверный api на получение пользователя: user.get. Этот запрос должен срабатывать после validate-init-data.post.ts. На клиенте нужно добавить pinia store куда будет сохраняться полученный пользователь.

## User Stories

- Как пользователь Telegram Mini App, я хочу, чтобы мои данные пользователя были доступны в клиентском приложении после успешной валидации initData, чтобы приложение могло использовать информацию о моем профиле для персонализации интерфейса и отображения моих данных.

- Как разработчик клиентской части, я хочу иметь доступ к данным пользователя через Pinia store, чтобы использовать эту информацию в различных компонентах приложения без необходимости повторных запросов к серверу.

- Как система, я хочу автоматически загружать данные пользователя из базы данных после успешной валидации initData, чтобы обеспечить актуальность информации о пользователе и его доступность во всех частях приложения.

## Main scenarios and rules

### Основной сценарий успешного получения пользователя

1. Клиентская часть выполняет запрос `POST /api/telegram/validate-init-data` с `initData` в теле запроса.
2. Сервер валидирует `initData` и, при успешной валидации, сохраняет пользователя в Supabase (если еще не сохранен).
3. После успешной валидации клиент автоматически вызывает новый endpoint `GET /api/user/get` для получения данных пользователя.
4. Серверный endpoint извлекает `telegram_id` из валидированного `initData` (из текущей сессии или передается в запросе).
5. Сервер выполняет запрос к таблице `users` в Supabase для поиска пользователя по `telegram_id`.
6. Если пользователь найден, сервер возвращает его данные клиенту в формате JSON.
7. Клиент сохраняет полученные данные пользователя в Pinia store для дальнейшего использования в приложении.

### Альтернативные сценарии

#### Пользователь не найден в базе данных

- Если пользователь не найден в таблице `users` по `telegram_id`, сервер возвращает ошибку 404 с соответствующим сообщением.
- Клиент обрабатывает ошибку и может отобразить соответствующее сообщение пользователю или выполнить повторную попытку.

#### Ошибка при запросе к базе данных

- Если произошла ошибка при запросе к Supabase, сервер возвращает ошибку 500 с описанием проблемы.
- Ошибка логируется на сервере для последующего анализа.
- Клиент может отобразить общее сообщение об ошибке или предложить повторить операцию.

#### InitData отсутствует или невалиден

- Если `initData` не был передан или валидация не прошла, запрос `GET /api/user/get` должен вернуть ошибку 401 (Unauthorized).
- Клиент не должен пытаться получить данные пользователя, если валидация initData не прошла успешно.

### Правила идентификации пользователя

- Пользователь идентифицируется по `telegram_id`, который извлекается из валидированного `initData`.
- `telegram_id` должен быть передан в запросе `GET /api/user/get` либо через параметр запроса, либо через заголовок, либо извлекаться из текущей сессии (если используется механизм сессий).
- Значение `telegram_id` должно быть числом, соответствующим `id` пользователя из Telegram.

### Правила работы с Pinia store

- Store должен хранить объект пользователя со всеми полями из таблицы `users`.
- Store должен предоставлять реактивное состояние, доступное для использования в компонентах Vue.
- Store должен иметь методы для обновления данных пользователя и очистки состояния при выходе пользователя.
- Store должен быть инициализирован как пустой объект `null` или `undefined` до первого успешного запроса.

## Non-functional requirements

- **Производительность**: Запрос получения пользователя должен выполняться не более чем за 300ms при нормальных условиях работы базы данных.
- **Безопасность**: Данные пользователя должны возвращаться только после успешной валидации `initData`. Endpoint должен проверять валидность `initData` или использовать безопасный механизм идентификации пользователя (например, через сессию с проверкой подписи).
- **Надежность**: Ошибки при запросе к базе данных должны обрабатываться корректно с возвратом соответствующих HTTP статусов. Ошибки не должны приводить к краху приложения.
- **Логирование**: Все запросы получения пользователя должны логироваться на сервере с указанием `telegram_id` для отслеживания и отладки.
- **Кэширование**: Клиентская часть может кэшировать данные пользователя в Pinia store до обновления страницы или выхода пользователя. При необходимости можно реализовать механизм обновления данных.
- **Совместимость**: Реализация должна быть совместима с существующими API endpoints и не нарушать текущие контракты с клиентской частью.

## Assumptions

- Таблица `users` существует в Supabase и содержит данные пользователей, сохраненные после валидации initData.
- Поле `telegram_id` в таблице `users` используется для поиска пользователя и является уникальным идентификатором.
- Endpoint `GET /api/user/get` должен иметь доступ к `telegram_id` пользователя либо через параметры запроса (переданный клиентом после валидации), либо через механизм сессий, либо через повторную проверку `initData` в запросе.
- Pinia установлен и настроен в проекте. Если Pinia отсутствует, его необходимо установить и настроить перед использованием.
- Клиентская часть использует Nuxt 3, что обеспечивает поддержку Pinia через модуль или прямую установку.

