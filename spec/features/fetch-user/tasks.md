# Tasks

**Context:** добавить новый серверный api на получение пользователя: user.get. Этот запрос должен срабатывать после validate-init-data.post.ts. На клиенте нужно добавить pinia store куда будет сохраняться полученный пользователь.

## Main directions

### Серверный API endpoint

- [ ] Создать файл `server/api/user/get.get.ts` с реализацией endpoint для получения пользователя
  - Реализовать обработчик GET запроса
  - Извлечь `telegram_id` из query параметров запроса
  - Валидировать наличие и корректность `telegram_id` (должен быть числом)
  - Выполнить запрос к Supabase: `SELECT * FROM users WHERE telegram_id = ?`
  - Обработать случай, когда пользователь не найден (вернуть 404)
  - Обработать ошибки базы данных (вернуть 500)
  - Вернуть данные пользователя в формате JSON при успехе
  - Добавить логирование всех операций с префиксом `[User Fetch]`
  - Проверить, что endpoint возвращает корректные HTTP статусы и структуру ответа

- [ ] Добавить TypeScript типы для ответа API
  - Создать интерфейс для успешного ответа с данными пользователя
  - Создать интерфейс для ошибок
  - Использовать существующий тип `TelegramUser` из `server/utils/telegram.ts` или создать общий тип `User`

### Установка и настройка Pinia

- [ ] Проверить наличие Pinia в проекте
  - Проверить `package.json` на наличие `pinia` или `@pinia/nuxt`
  - Если отсутствует, добавить зависимость через `npm install pinia` или `npm install @pinia/nuxt`

- [ ] Настроить Pinia в Nuxt конфигурации
  - Если используется `@pinia/nuxt`, добавить модуль в `nuxt.config.ts` в секцию `modules`
  - Если используется `pinia`, создать плагин `plugins/pinia.client.ts` для инициализации Pinia
  - Проверить, что Pinia доступен в компонентах и composables

### Клиентский Pinia store

- [ ] Создать директорию `stores/` в корне проекта (если не существует)

- [ ] Создать файл `stores/user.ts` с реализацией Pinia store
  - Определить интерфейс состояния `UserState` с полями: `user: User | null`, `isLoading: boolean`, `error: string | null`
  - Создать store используя `defineStore` из Pinia
  - Реализовать state с начальными значениями: `user: null`, `isLoading: false`, `error: null`
  - Реализовать getters для доступа к состоянию (опционально, можно использовать прямое обращение к state)
  - Реализовать action `fetchUser(telegramId: number)`: 
    - Установить `isLoading: true`, очистить `error`
    - Выполнить GET запрос к `/api/user/get?telegram_id=${telegramId}`
    - При успехе сохранить данные в `user`, установить `isLoading: false`
    - При ошибке установить `error` с сообщением, установить `isLoading: false`
  - Реализовать action `setUser(user: User | null)` для установки пользователя напрямую
  - Реализовать action `clearUser()` для очистки состояния пользователя
  - Добавить TypeScript типы для всех методов и состояния
  - Проверить реактивность store в Vue компонентах

### Интеграция с validate-init-data

- [ ] Обновить логику вызова fetchUser после успешной валидации initData
  - Открыть файл `composables/useTelegram.ts` или определить место, где вызывается `sendInitDataToServer`
  - После успешного ответа от `POST /api/telegram/validate-init-data` извлечь `telegram_id` из `initData`
  - Вызвать `fetchUser` из Pinia store с полученным `telegram_id`
  - Обработать ошибки при загрузке пользователя (логировать, но не прерывать основной поток)
  - Убедиться, что загрузка пользователя не блокирует инициализацию Telegram WebApp

- [ ] Создать вспомогательную функцию для извлечения telegram_id из initData
  - Использовать функцию `parseInitDataUser` из `server/utils/telegram.ts` как референс
  - Реализовать клиентскую версию парсинга или использовать существующую библиотеку
  - Извлечь `id` (telegram_id) из распарсенного объекта пользователя
  - Обработать случай, когда пользователь отсутствует в initData

### Тестирование и проверка

- [ ] Протестировать серверный endpoint вручную или через тесты
  - Проверить успешный сценарий получения пользователя
  - Проверить обработку ошибки 404 (пользователь не найден)
  - Проверить обработку ошибки при невалидном telegram_id
  - Проверить логирование операций

- [ ] Протестировать Pinia store
  - Проверить инициализацию store с пустым состоянием
  - Проверить успешную загрузку пользователя через `fetchUser`
  - Проверить обработку ошибок при загрузке
  - Проверить методы `setUser` и `clearUser`
  - Проверить реактивность состояния в Vue компонентах

- [ ] Протестировать интеграцию
  - Проверить автоматический вызов `fetchUser` после успешной валидации initData
  - Проверить, что данные пользователя корректно сохраняются в store
  - Проверить работу в случае, когда валидация initData не прошла
  - Проверить работу в случае, когда пользователь не найден в базе

## Supporting tasks

- [ ] Документация: добавить описание нового API endpoint в документацию проекта (если существует)
  - Описать endpoint `GET /api/user/get`, его параметры и ответы
  - Добавить примеры использования Pinia store в компонентах
  - Обновить README или другой файл документации при необходимости

- [ ] Observability: убедиться в наличии логирования операций
  - Проверить, что все операции с пользователем логируются на сервере
  - Убедиться, что логи содержат достаточно информации для отладки (telegram_id, ошибки)
  - При необходимости добавить дополнительное логирование на клиенте для отладки

- [ ] Code review and PR: подготовить изменения для ревью
  - Проверить соответствие кода стилю проекта
  - Убедиться в наличии TypeScript типов для всех новых компонентов
  - Проверить обработку ошибок во всех местах
  - Подготовить описание изменений для PR

## Definition of Done

- [ ] Все задачи выполнены и протестированы
- [ ] Серверный endpoint `GET /api/user/get` работает корректно и возвращает данные пользователя
- [ ] Pinia установлен и настроен в проекте
- [ ] Pinia store для пользователя создан и функционирует
- [ ] Интеграция с validate-init-data реализована и работает автоматически
- [ ] Обработка ошибок реализована во всех компонентах
- [ ] TypeScript типы определены и используются корректно
- [ ] Логирование операций добавлено для отладки и мониторинга
- [ ] Код протестирован вручную и работает в среде разработки
- [ ] `/spec/core/verify.md` выполнен после завершения всех задач для проверки списка задач

