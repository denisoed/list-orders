# Tasks

**Context:** У нас есть серверная функция, которая принимает initData и валидирует его. Если валидация проходит успешно, то нужно парсить и сохранять пользователя в supabase в таблицу users используя server/utils/supabase.ts. Но нужно проверить, что если такой пользователь сохранен уже, то ничего не делать, не сохранять.

## Main directions

### Серверная часть: парсинг initData и извлечение данных пользователя

- [x] Создать утилитарную функцию `parseInitDataUser(initData: string)` для парсинга initData и извлечения объекта пользователя.
- [x] Реализовать разбор query-параметров из строки initData с использованием `URLSearchParams` или ручного парсинга.
- [x] Реализовать декодирование URL-encoded параметра `user` с использованием `decodeURIComponent`.
- [x] Реализовать парсинг JSON-строки в объект пользователя с обработкой ошибок парсинга.
- [x] Добавить TypeScript интерфейс `TelegramUser` для типизации объекта пользователя из initData.
- [x] Добавить логирование ошибок парсинга с префиксом `[Telegram User Save]`.

**Проверка:** Убедиться, что функция корректно парсит различные форматы initData, обрабатывает отсутствие параметра `user`, корректно декодирует URL-encoded строки и парсит JSON. Протестировать с валидными и невалидными входными данными.

### Серверная часть: сохранение пользователя в Supabase

- [x] Создать функцию `saveUserToSupabase(user: TelegramUser)` для сохранения пользователя в таблицу `users`.
- [x] Реализовать получение клиента Supabase через `getSupabaseClient()` из `server/utils/supabase.ts`.
- [x] Реализовать проверку существования пользователя через запрос `select().eq('telegram_id', user.id).single()` к таблице `users`, где значение поля `id` из объекта пользователя сравнивается с полем `telegram_id` в таблице.
- [x] Реализовать обработку результата проверки: если пользователь найден, завершить функцию без действий.
- [x] Реализовать обработку ошибки `PGRST116` (или аналогичной) при проверке как нормальной ситуации (пользователь не найден).
- [x] Реализовать вставку новой записи через `insert()` с данными пользователя, если пользователь не найден.
- [x] Реализовать маппинг полей из объекта `TelegramUser` в колонки таблицы `users`, где поле `id` из объекта пользователя сохраняется в поле `telegram_id` таблицы, а остальные поля маппятся напрямую (first_name, last_name, username, language_code, is_premium, photo_url).
- [x] Добавить логирование всех операций (проверка существования, вставка) с префиксом `[Telegram User Save]`.
- [x] Добавить обработку ошибок вставки с логированием, но без прерывания выполнения.

**Проверка:** Убедиться, что функция корректно проверяет существование пользователя, не создает дублирующие записи, корректно сохраняет данные при первом сохранении. Протестировать сценарии: новый пользователь, существующий пользователь, ошибки Supabase.

### Серверная часть: интеграция в endpoint валидации

- [x] Модифицировать файл `server/api/telegram/validate-init-data.post.ts` для добавления сохранения пользователя.
- [x] Добавить вызов `parseInitDataUser()` после успешной валидации initData.
- [x] Добавить проверку результата парсинга: если парсинг успешен, вызвать `saveUserToSupabase()`.
- [x] Обеспечить, что все операции сохранения выполняются асинхронно и не блокируют возврат ответа API.
- [x] Обеспечить, что ошибки парсинга и сохранения не влияют на успешный ответ валидации.
- [x] Добавить обработку ошибок с логированием, но без изменения формата ответа API.

**Проверка:** Убедиться, что endpoint продолжает возвращать `{ success: true }` при успешной валидации, независимо от результатов сохранения пользователя. Проверить, что валидация работает как раньше, сохранение пользователя происходит в фоне. Протестировать сценарии: успешная валидация с новым пользователем, успешная валидация с существующим пользователем, успешная валидация без данных пользователя в initData.

## Supporting tasks

- [x] Документация: добавить JSDoc комментарии к функциям `parseInitDataUser` и `saveUserToSupabase` с описанием параметров, возвращаемых значений и примеров использования.
- [x] Observability: убедиться, что все операции логируются с понятными префиксами для возможности мониторинга и отладки. Добавить логирование успешных операций сохранения пользователя.
- [x] Code review and PR: подготовить изменения для review, убедиться, что код соответствует стандартам проекта, не нарушает существующие контракты API.

## Definition of Done

- [ ] Все задачи выполнены и протестированы.
- [ ] Функция парсинга initData корректно извлекает данные пользователя из различных форматов initData.
- [ ] Функция сохранения пользователя корректно проверяет существование и не создает дублирующие записи.
- [ ] Интеграция в endpoint не нарушает существующий контракт API.
- [ ] Все ошибки обрабатываются корректно с логированием, не прерывая основной поток валидации.
- [ ] Код покрыт комментариями и готов для code review.
- [ ] `/spec/core/verify.md` выполняется после завершения всех задач для верификации списка задач.

