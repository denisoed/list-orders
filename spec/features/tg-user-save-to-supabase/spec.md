# Telegram User Save to Supabase

**Specification:** У нас есть серверная функция, которая принимает initData и валидирует его. Если валидация проходит успешно, то нужно парсить и сохранять пользователя в supabase в таблицу users используя server/utils/supabase.ts. Но нужно проверить, что если такой пользователь сохранен уже, то ничего не делать, не сохранять.

## User Stories

- Как система, я хочу автоматически сохранять данные пользователя Telegram в базу данных после успешной валидации initData, чтобы обеспечить персистентность информации о пользователях и возможность их дальнейшего использования в приложении.
- Как администратор системы, я хочу, чтобы система не создавала дублирующие записи пользователей в базе данных, чтобы избежать избыточности данных и потенциальных проблем с целостностью данных.
- Как пользователь Telegram Mini App, я хочу, чтобы мои данные были корректно сохранены в системе после первой успешной валидации, чтобы система могла идентифицировать меня в последующих сессиях.

## Main scenarios and rules

### Основной сценарий успешного сохранения

1. Серверная функция `POST /api/telegram/validate-init-data` получает `initData` в теле запроса.
2. Выполняется валидация `initData` с помощью функции `validate` из пакета `@telegram-apps/init-data-node`.
3. Если валидация успешна, выполняется парсинг `initData` для извлечения данных пользователя.
4. Из парсированного `initData` извлекается объект пользователя (обычно находится в параметре `user` в формате JSON-строки).
5. Получается клиент Supabase через функцию `getSupabaseClient()` из `server/utils/supabase.ts`.
6. Выполняется проверка существования пользователя в таблице `users` по полю `telegram_id`, используя значение поля `id` из объекта пользователя из `initData`.
7. Если пользователь не существует, выполняется вставка новой записи в таблицу `users` с данными из `initData`, где значение поля `id` из объекта пользователя сохраняется в поле `telegram_id`.
8. Если пользователь уже существует, операция вставки не выполняется, функция завершается без ошибки.

### Правила обработки ошибок

- Если валидация `initData` не прошла, процесс сохранения пользователя не запускается, возвращается ошибка валидации как обычно.
- Если парсинг `initData` не удался (отсутствует поле `user` или оно некорректно), логируется предупреждение, но процесс не прерывается с ошибкой, чтобы не нарушать текущую работу валидации.
- Если проверка существования пользователя в Supabase завершилась с ошибкой (кроме случая отсутствия записи), ошибка логируется, но не прерывает основной поток валидации.
- Если вставка нового пользователя завершилась с ошибкой, ошибка логируется, но не возвращается клиенту, чтобы не нарушать текущий контракт API валидации.

### Правила определения существования пользователя

- Проверка выполняется по полю `telegram_id` в таблице `users` в Supabase.
- Значение для проверки берется из поля `id` объекта пользователя, извлеченного из `initData`.
- Используется метод `select` с фильтром `eq('telegram_id', user.id)` и `single()` для поиска пользователя в таблице `users`.
- Если запись найдена, считается, что пользователь уже существует, и операция сохранения не выполняется.
- Если запись не найдена (ошибка с кодом `PGRST116` или аналогичным), считается, что пользователь не существует и требуется вставка новой записи.

## Non-functional requirements

- **Производительность**: Операции проверки существования и вставки пользователя должны выполняться асинхронно и не блокировать основной поток обработки запроса валидации более чем на 200-300ms.
- **Безопасность**: Данные пользователя из `initData` должны сохраняться только после успешной валидации подписи. Никакие данные не должны сохраняться, если валидация не прошла.
- **Надежность**: Операции с базой данных должны быть устойчивы к временным сбоям. Ошибки при сохранении пользователя не должны нарушать основной функционал валидации.
- **Логирование**: Все операции сохранения пользователя должны логироваться с соответствующими префиксами для удобства отладки и мониторинга.
- **Совместимость**: Реализация должна быть совместима с существующим API endpoint и не нарушать текущие контракты с клиентской частью.

## Assumptions

- Таблица `users` уже существует в Supabase и имеет необходимые колонки для хранения данных пользователя Telegram, включая обязательное поле `telegram_id` для идентификации пользователя.
- Поле `telegram_id` в таблице `users` является уникальным и используется для проверки существования пользователя. Значение `telegram_id` берется из поля `id` объекта пользователя из `initData`.
- Объект пользователя в `initData` доступен в параметре `user` в формате JSON-строки, который может быть распарсен стандартными средствами JavaScript/TypeScript.
- Пакет `@telegram-apps/init-data-node` не предоставляет готовой функции парсинга `initData`, поэтому парсинг будет выполняться вручную через разбор query-параметров и декодирование JSON.
- Клиент Supabase настроен корректно и имеет необходимые права доступа для чтения и записи в таблицу `users`.

