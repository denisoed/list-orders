# Implementation Plan

**Plan:** Нужно добавить и настроить Supabase в проект на стороне сервера. Добавить env example и тд. Настроить минимально.

## Data sources / schemas

Не требуется — причина: задача только в базовой инициализации Supabase клиента на сервере. Работа с базой данных, создание схем, миграции и индексы выходят за рамки текущей задачи и будут реализованы в последующих фичах.

## Contracts and interfaces

### Переменные окружения

Обязательные переменные для серверной части:

- `SUPABASE_URL` — URL проекта Supabase (например, https://xxx.supabase.co)
- `SUPABASE_SERVICE_ROLE_KEY` — Service Role Key для серверных операций с полными правами доступа

Опциональные переменные (для будущего использования):

- `SUPABASE_ANON_KEY` — анонимный ключ для публичных операций

### API Supabase клиента

- Серверный клиент будет доступен через Nuxt server utilities (composable или helper)
- Клиент типа `SupabaseClient` из `@supabase/supabase-js`
- Клиент инициализируется один раз и переиспользуется

### Формат ошибок

- При отсутствии обязательных переменных: логирование предупреждения при старте
- При ошибке подключения: стандартные ошибки Supabase клиента

## Architecture / Components

### Структура компонентов

1. **Supabase серверный модуль/plugin**
   - Создание серверного клиента Supabase при инициализации Nuxt
   - Использование Nuxt plugins или server utilities для инъекции клиента
   - Типизация клиента для TypeScript

2. **Переменные окружения**
   - Файл `.env.example` с примером необходимых переменных
   - Проверка наличия `.env` в `.gitignore`

3. **Зависимости**
   - Установка `@supabase/supabase-js` пакета
   - TypeScript типы уже включены в пакет

### Технический стек

- **Runtime**: Node.js (Nuxt 4 серверная часть)
- **Библиотека**: `@supabase/supabase-js` — официальный JavaScript клиент Supabase
- **Интеграция**: Nuxt plugins или server utilities для создания серверного singleton клиента

### Архитектурные решения

- **Singleton паттерн**: клиент создается один раз и переиспользуется
- **Lazy initialization**: клиент создается только при первом использовании или при старте сервера
- **Server-only**: клиент доступен только в server-side контексте Nuxt

### Интеграция с существующим кодом

- Интеграция с существующей структурой `server/api/`
- Возможность использования клиента в server routes и middleware
- Соответствие паттернам существующего кода (например, `server/api/telegram/validate-init-data.post.ts`)

## Risks

1. **Отсутствие переменных окружения в production**
   - **Митигация**: проверка наличия переменных при инициализации с логированием ошибок

2. **Утечка Service Role Key в клиентский код**
   - **Митигация**: использование только в server-side контексте, проверка через TypeScript типы и документация

3. **Конфликт версий пакета `@supabase/supabase-js`**
   - **Митигация**: использование стабильной версии, обновление с осторожностью

4. **Избыточная сложность при минимальных требованиях**
   - **Митигация**: строгое следование принципу минимальной настройки, без дополнительных абстракций

## Assumptions

1. Nuxt 4 поддерживает server plugins/utilities для создания серверных singleton сервисов
2. Проект Supabase уже создан, разработчик имеет доступ к URL и Service Role Key
3. TypeScript конфигурация проекта совместима с типами из `@supabase/supabase-js`
4. Минимальная настройка означает только базовое подключение без миграций, схем БД и дополнительных сервисов
5. `.gitignore` уже настроен и включает `.env` файл (требуется проверка)

